#!/usr/bin/env sh

cd $(dirname "$0")

touch -a ~/.ssh/config #aqui es donde se agregaran los servidores

if [ "Msys" == $(uname -o) ] 2> /dev/null;then
	fzf="./bin/fzf.exe"
else
        fzf="./bin/fzf"
fi

while true;
do
op=$(printf "1 - Acceder SSH\n2 - Agregar Servidor\n3 - Salir" | $fzf --layout=reverse | awk '{print $1}')
case $op in

2) clear && read -p "ServerName: " host
	if ! grep -q "Host $host" ~/.ssh/config;then
		read -p "UserName: " id
		read -p "Server IP: " ip
		
		read -p "Desea acceder por llave?(y/n): " yn1
		if [ "$yn1" = 'y' ];then
			read -p "Ingrese Ruta de llave: " key
		fi

		read -p "Desea agregarle un Servidor de salto?(y/n): " yn2
		if [ "$yn2" = 'y' ];then
			read -p "Hostname del servidor de salto: " hostjump
		fi

		if [ "$yn1" = 'y' ] && [ "$yn2" = 'y' ];then
			printf "\n
			\nHost $host
			HostName $ip
			User $id
			IdentityFile $key
			ProxyJump $hostjump">> ~/.ssh/config

		elif [ "$yn1" = 'y' ] && [ "$yn2" = 'n' ];then
                        printf "\n
                        \nHost $host
                        HostName $ip
                        User $id
                        IdentityFile $key">> ~/.ssh/config

		elif [ "$yn1" = 'n' ] && [ "$yn2" = 'y' ];then
                        printf "\n
                        \nHost $host
                        HostName $ip
                        User $id
                        ProxyJump $hostjump">> ~/.ssh/config

		elif [ "$yn1" = 'n' ] && [ "$yn2" = 'n' ];then
			ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub $id@$ip
			printf "\n
			\nHost $host
			HostName $ip
			User $id">> ~/.ssh/config
		else
			echo "Respuesta incorrecta, intentalo de new"
		fi

		clear && echo "Servidor $host agregado!" && sleep 1s
	else
		clear && echo "Servidor $host ya existe" && sleep 1s
	fi;;


1) server=$(cat ~/.ssh/config | grep -Ev "HostName|User|IdentityFile|ProxyJump" | awk '{print $2}' | awk /./ | sort -k 3 | $fzf --layout=reverse)
	ssh $server 2> /dev/null;;


3) clear && echo "Adios!" && exit 1;;


*) clear && echo "No valido, Intente de new" && sleep 1s;;
esac
done
